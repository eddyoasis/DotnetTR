@model TradingLimitMVC.Models.PurchaseOrder
@{
    ViewData["Title"] = "Create Purchase Order from Approved PR";
    var sourcePR = ViewBag.SourcePR as PurchaseRequisition;
}

<style>
    .po-form-container {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
        padding: 20px 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .main-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        margin: 20px auto;
        max-width: 1400px;
        overflow: hidden;
    }

    .header-section {
        background: linear-gradient(135deg, var(--primary-color), #004499);
        color: white;
        padding: 30px;
        text-align: center;
    }

        .header-section h1 {
            font-size: 32px;
            font-weight: 700;
            margin: 0;
        }

        .header-section p {
            margin: 10px 0 0 0;
            opacity: 0.95;
            font-size: 16px;
        }

    /* PR Info Banner */
    .pr-info-banner {
        background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        padding: 25px;
        border-left: 5px solid #2196f3;
        margin: 0;
    }

        .pr-info-banner h5 {
            color: #1565c0;
            margin-bottom: 15px;
            font-weight: 700;
            font-size: 18px;
        }

    .pr-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }

    .pr-info-item {
        background: white;
        padding: 12px 15px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

        .pr-info-item strong {
            display: block;
            color: #1565c0;
            font-size: 12px;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .pr-info-item span {
            color: #212529;
            font-size: 16px;
            font-weight: 600;
        }

    .cost-centers-section {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 2px solid #90caf9;
    }

    .cost-center-badge {
        display: inline-block;
        background: #004499;
        color: white;
        padding: 8px 15px;
        border-radius: 20px;
        margin: 5px;
        font-size: 13px;
        font-weight: 600;
    }

    /* Form Content */
    .form-content {
        padding: 35px;
    }

    .section-card {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
        border: 1px solid #dee2e6;
    }

    .section-header {
        color: #004499;
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 3px solid #004499;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .form-grid-2 {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-bottom: 15px;
    }

    .form-grid-4 {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
        margin-bottom: 15px;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-label {
        font-weight: 600;
        margin-bottom: 6px;
        display: block;
        color: #495057;
        font-size: 13px;
    }

    .form-control, .form-select {
        width: 100%;
        padding: 10px 12px;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s;
    }

        .form-control:focus, .form-select:focus {
            border-color: #004499;
            outline: none;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
        }

        .form-control:read-only {
            background: #e9ecef;
            cursor: not-allowed;
        }

    .required {
        color: #dc3545;
        font-weight: 700;
    }

    /* Department Sections */
    .departments-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 25px;
        margin-top: 20px;
    }

    .department-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        border: 2px solid #dee2e6;
    }

    .department-title {
        background: linear-gradient(135deg, var(--primary-color), #004499);
        color: white;
        padding: 12px 18px;
        border-radius: 8px;
        font-weight: 700;
        font-size: 16px;
        margin: -20px -20px 20px -20px;
        text-align: center;
    }

    .radio-group {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        margin-top: 8px;
    }

    .radio-option {
        display: flex;
        align-items: center;
        gap: 8px;
        background: #f8f9fa;
        padding: 8px 15px;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s;
    }

        .radio-option:hover {
            background: #e9ecef;
        }

        .radio-option input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .radio-option label {
            cursor: pointer;
            font-weight: 500;
            margin: 0;
            font-size: 14px;
        }

    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 10px;
        background: #f8f9fa;
        padding: 10px 15px;
        border-radius: 8px;
        margin-top: 8px;
    }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-group label {
            cursor: pointer;
            font-weight: 500;
            margin: 0;
        }

    /* Items Table */
    .items-section {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
        border: 2px solid #004499;
    }

    .items-table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
        font-size: 13px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border-radius: 8px;
        overflow: hidden;
    }

        .items-table thead {
            background: linear-gradient(135deg, var(--primary-color), #004499);
            color: white;
        }

        .items-table th {
            padding: 15px 10px;
            text-align: center;
            font-weight: 600;
            font-size: 13px;
            border: none;
        }

        .items-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #dee2e6;
            text-align: center;
        }

        .items-table tbody tr {
            transition: background 0.2s;
        }

            .items-table tbody tr:hover {
                background: #f8f9fa;
            }

            .items-table tbody tr:last-child td {
                border-bottom: none;
            }

        .items-table tfoot {
            background: linear-gradient(135deg, var(--primary-color), #004499);
            color: white;
            font-weight: 700;
            font-size: 16px;
        }

            .items-table tfoot td {
                padding: 15px;
                border: none;
            }

    /* Action Buttons */
    .action-buttons {
        display: flex;
        justify-content: center;
        gap: 15px;
        padding: 30px;
        background: #f8f9fa;
        border-radius: 12px;
        margin-top: 30px;
    }

    .btn-submit {
        background: linear-gradient(45deg, #28a745, #20c997);
        color: white;
        padding: 15px 40px;
        border: none;
        border-radius: 25px;
        font-weight: 600;
        cursor: pointer;
        font-size: 16px;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        transition: all 0.3s;
        box-shadow: 0 4px 10px rgba(40, 167, 69, 0.3);
    }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(40, 167, 69, 0.4);
        }

    .btn-cancel {
        background: #6c757d;
        color: white;
        padding: 15px 40px;
        border: none;
        border-radius: 25px;
        font-weight: 600;
        cursor: pointer;
        font-size: 16px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        transition: all 0.3s;
    }

        .btn-cancel:hover {
            background: #5a6268;
            transform: translateY(-2px);
            color: white;
        }

    .pr-info-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr); /*  Changed to 4 columns */
        gap: 15px;
        margin-top: 15px;
    }

    @@media (max-width: 1200px) {
        .pr-info-grid

    {
        grid-template-columns: repeat(2, 1fr);
    }

    }

    @@media (max-width: 768px) {
        .pr-info-grid

    {
        grid-template-columns: 1fr;
    }

    }
    /* Responsive */
    @@media (max-width: 768px) {
        .form-grid-2, .form-grid-4, .departments-grid, .pr-info-grid

    {
        grid-template-columns: 1fr;
    }

    }
</style>

<div class="po-form-container">
    <div class="main-card">
        <!-- Header -->
        <div class="header-section">
            <h1><i class="fas fa-file-invoice"></i> Create Purchase Order</h1>
            <p>From Approved Purchase Requisition</p>
        </div>

        <!-- PR Summary Banner -->
        @if (ViewBag.SourcePR != null)
        {
            <div class="pr-info-banner">
                <h5><i class="fas fa-info-circle"></i> Source Purchase Requisition Details</h5>

                <div class="pr-info-grid">
                    <!-- Row 1 -->
                    <div class="pr-info-item">
                        <strong>PR Reference</strong>
                        <span style="color: #2196f3;">@sourcePR.PRReference</span>
                    </div>
                    <div class="pr-info-item">
                        <strong>PR ID</strong>
                        <span>@sourcePR.Id</span>
                    </div>
                    <div class="pr-info-item">
                        <strong>Total Amount</strong>
                        <span style="color: #004499;">@sourcePR.TotalAmount.ToString("C")</span>
                    </div>
                    <div class="pr-info-item">
                        <strong>Approved By</strong>
                        <span>@(ViewBag.PRApprovedBy ?? sourcePR.FinalApprover ?? "N/A")</span>
                    </div>

                    <!-- Row 2 -->
                    <div class="pr-info-item">
                        <strong>Approval Date</strong>
                        <span>@((ViewBag.PRApprovalDate ?? sourcePR.FinalApprovalDate)?.ToString("MMM dd, yyyy") ?? "N/A")</span>
                    </div>
                    <div class="pr-info-item">
                        <strong>PR Originator</strong>
                        <span>@(ViewBag.PROriginator ?? sourcePR.SubmittedBy ?? "N/A")</span>
                    </div>
                    <div class="pr-info-item">
                    <strong>Payment Terms (Days)</strong>
                    <span>@(ViewBag.PRPaymentTerms ?? Model.PaymentTerms ?? "Net 30")</span>  
                    </div>
                    <div class="pr-info-item">
                        <strong>Company</strong>
                        <span>@sourcePR.Company</span>
                    </div>
                </div>

                @if (ViewBag.PRCostCenters != null)
                {
                    var costCenters = ViewBag.PRCostCenters as IEnumerable<CostCenter>;
                    if (costCenters.Any())
                    {
                        <div class="cost-centers-section">
                            <strong style="color: #004499; display: block; margin-bottom: 10px;">Cost Centers:</strong>
                            @foreach (var cc in costCenters)
                            {
                                <span class="cost-center-badge">
                                    @cc.Name: @cc.Amount.Value.ToString("C")
                                </span>
                            }
                        </div>
                    }
                }
            </div>
        }

        <form asp-action="CreateFromPR" method="post">
            @Html.AntiForgeryToken()
            <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

            <!-- Hidden Fields -->
            <input type="hidden" asp-for="POReference" />
            <input type="hidden" asp-for="PONo" />
            <input type="hidden" asp-for="PurchaseRequisitionId" value="@Model.PurchaseRequisitionId" />
            <input type="hidden" asp-for="PRReference" value="@Model.PRReference" />

            <div class="form-content">
                <!-- PO Details Section -->
                <div class="section-card">
                    <div class="section-header">
                        <i class="fas fa-file-alt"></i> Purchase Order Details
                    </div>
                    <div class="form-grid-4">
                        <div class="form-group">
                            <label class="form-label">PO Reference</label>
                            <input asp-for="POReference" class="form-control" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">PO Number</label>
                            <input asp-for="PONo" class="form-control" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Issue Date</label>
                            <input asp-for="IssueDate" type="date" class="form-control" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Delivery Date</label>
                            <input asp-for="DeliveryDate" type="date" class="form-control">
                        </div>
                    </div>
                </div>

                <!--  VENDOR INFORMATION CARD -->
                <div class="section-card">
                <div class="section-header">
                <i class="fas fa-store"></i> Vendor Information <span class="required">*</span>
                </div>
                <div class="form-grid-2">
                <div class="form-group">
                <label class="form-label">Vendor <span class="required">*</span></label>
                <input asp-for="Vendor" class="form-control" readonly style="background: #e9ecef;">
                <small class="text-muted">
                                @if (!string.IsNullOrEmpty(Model.Vendor) && Model.Vendor != "TBD - Please Select Vendor")
                                {
                <i class="fas fa-check-circle text-success"></i> <text>From PR Suggested Supplier</text>
                                }
                                else
                                {
                <i class="fas fa-exclamation-triangle text-warning"></i> <text>No vendor selected in PR</text>
                                }
                </small>
                </div>
                <div class="form-group">
                <label class="form-label">Vendor Address</label>
                <textarea asp-for="VendorAddress" class="form-control" rows="2" readonly style="background: #e9ecef;"></textarea>
                </div>
                </div>
                <div class="row">
                <div class="col-md-6">
                <div class="form-group">
                <label class="form-label">Attention </label>
                <input asp-for="Attention" class="form-control" readonly style="background: #e9ecef;">
                <small class="text-muted">From vendor: @ViewBag.VendorName</small>
                </div>
                </div>
                <div class="col-md-6">
                <div class="form-group">
                <label class="form-label">Phone No </label>
                <input asp-for="PhoneNo" class="form-control" readonly style="background: #e9ecef;">
               
                </div>
                </div>
                </div>
                <div class="row">
                <div class="col-md-6">
                <div class="form-group">
                <label class="form-label">Email </label>
                <input asp-for="Email" type="email" class="form-control" readonly style="background: #e9ecef;">
                </div>
                </div>
                <div class="col-md-6">
                <div class="form-group">
                <label class="form-label">Fax No </label>
                <input asp-for="FaxNo" class="form-control" readonly style="background: #e9ecef;">
                </div>
                </div>
                </div>

                <!-- DELIVERY INFORMATION CARD -->
                <div class="section-card">
                <div class="section-header">
                <i class="fas fa-truck"></i> Delivery Information
                </div>
                <div class="form-grid-2">
                <div class="form-group">
                <label class="form-label">Company</label>
                <input asp-for="Company" class="form-control" readonly style="background: #e9ecef;">
                <small class="text-muted">From PR</small>
                </div>
                <div class="form-group">
                <label class="form-label">Contact Person</label>
                <input type="text" value="@ViewBag.PRContactPerson" class="form-control" readonly style="background: #e9ecef;">
                <small class="text-muted">From PR Contact Person</small>
                </div>
                </div>
                <div class="form-grid-2">
                <div class="form-group">
                <label class="form-label">Phone No</label>
                <input type="text" value="@ViewBag.PRContactPhone" class="form-control" readonly style="background: #e9ecef;">
                <small class="text-muted">From PR Contact Phone</small>
                </div>
                <div class="form-group">
                <label class="form-label">PO Originator</label>
                <input asp-for="POOriginator" class="form-control" readonly style="background: #e9ecef;">
                <small class="text-muted">PR Submitted By</small>
                </div>
                </div>
                <div class="form-group">
                <label class="form-label">Delivery Address</label>
                <textarea asp-for="DeliveryAddress" class="form-control" rows="2" readonly style="background: #e9ecef;"></textarea>
                <small class="text-muted">From PR Delivery Address</small>
                </div>
                </div>
                <!-- Department Information Section -->
                <div class="section-card">
                    <div class="section-header">
                        <i class="fas fa-building"></i> Department Information
                    </div>

                    <div class="departments-grid">
                        <!-- CS Department -->
                        <div class="department-card">
                            <div class="department-title">
                                <i class="fas fa-laptop"></i> CS Department
                            </div>

                            <div class="form-group">
                                <label class="form-label">Type</label>
                                <select name="CSType" class="form-select">
                                    <option value="">-- Select Type --</option>
                                    <option value="IT Equipment - PC">IT Equipment - PC</option>
                                    <option value="IT Equipment - Monitor">IT Equipment - Monitor</option>
                                    <option value="IT Equipment - PC & Monitor">IT Equipment - PC & Monitor</option>
                                    <option value="Office Supplies">Office Supplies</option>
                                    <option value="Software License">Software License</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Maintenance</label>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="maintenanceCheck" name="MaintenanceRequired">
                                    <label for="maintenanceCheck">Maintenance Required</label>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">From Date</label>
                                <input asp-for="MaintenanceFrom" type="date" class="form-control">
                            </div>

                            <div class="form-group">
                                <label class="form-label">To Date</label>
                                <input asp-for="MaintenanceTo" type="date" class="form-control">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Attn To</label>
                                <input type="text" name="CSAttnTo" class="form-control" placeholder="Attention to">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Remarks</label>
                                <textarea asp-for="CSRemarks" class="form-control" rows="3" placeholder="CS Department remarks..."></textarea>
                            </div>
                        </div>

                        <!-- IT Department -->
                        <div class="department-card">
                            <div class="department-title">
                                <i class="fas fa-server"></i> IT Department
                            </div>

                            <div class="form-group">
                                <label class="form-label">Payment</label>
                                <div class="radio-group">
                                    <div class="radio-option">
                                        <input type="radio" name="ITPaymentStatus" value="Not Pay" id="itNotPay" checked>
                                        <label for="itNotPay">Not Pay</label>
                                    </div>
                                    <div class="radio-option">
                                        <input type="radio" name="ITPaymentStatus" value="Partial" id="itPartial">
                                        <label for="itPartial">Partial</label>
                                    </div>
                                    <div class="radio-option">
                                        <input type="radio" name="ITPaymentStatus" value="Full" id="itFull">
                                        <label for="itFull">Full</label>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Note</label>
                                <input type="text" name="ITNote" class="form-control" placeholder="IT notes">
                            </div>

                            <div class="form-group">
                                <label class="form-label">KAM#</label>
                                <input type="text" name="KAMNumber" class="form-control" placeholder="KAM number">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Contract</label>
                                <input asp-for="ITContract" class="form-control" placeholder="Contract details">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Remarks</label>
                                <textarea asp-for="ITRemarks" class="form-control" rows="3" placeholder="IT Department remarks..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Purchase Items Section -->
                <div class="items-section">
                    <div class="section-header">
                        <i class="fas fa-shopping-cart"></i> Purchase Items (@Model.Items.Count items)
                    </div>

                    <table class="items-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;">#</th>
                                <th>Description</th>
                                <th style="width: 80px;">Quantity</th>
                                @* <th style="width: 100px;">Unit Price</th> *@
                                <th style="width: 100px;">Unit Price (<span id="selectedCurrency">USD</span>)</th>
                                <th style="width: 100px;">Discount</th>
                                <th style="width: 80px;">GST</th>
                                <th style="width: 120px;">Amount</th>
                                <th style="width: 100px;">PR No</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (int i = 0; i < Model.Items.Count; i++)
                            {
                                <tr>
                                    <td>@(i + 1)</td>
                                    <td style="text-align: left; padding-left: 15px;">
                                        @Model.Items[i].Description
                                        <input type="hidden" name="Items[@i].Description" value="@Model.Items[i].Description" />
                                        <input type="hidden" name="Items[@i].Details" value="@Model.Items[i].Details" />
                                    </td>
                                    <td>
                                        @Model.Items[i].Quantity
                                        <input type="hidden" name="Items[@i].Quantity" value="@Model.Items[i].Quantity" />
                                    </td>
                                    <td>
                                        @Model.Items[i].UnitPrice.ToString("C")
                                        <input type="hidden" name="Items[@i].UnitPrice" value="@Model.Items[i].UnitPrice" />
                                    </td>
                                    <td>
                                        @if (Model.Items[i].DiscountPercent > 0)
                                        {
                                            <text>@Model.Items[i].DiscountPercent%</text>
                                        }
                                        else
                                        {
                                            <text>@Model.Items[i].DiscountAmount.ToString("C")</text>
                                        }
                                        <input type="hidden" name="Items[@i].DiscountPercent" value="@Model.Items[i].DiscountPercent" />
                                        <input type="hidden" name="Items[@i].DiscountAmount" value="@Model.Items[i].DiscountAmount" />
                                    </td>
                                    <td>
                                        @Model.Items[i].GST
                                        <input type="hidden" name="Items[@i].GST" value="@Model.Items[i].GST" />
                                    </td>
                                    <td style="font-weight: bold; color: #28a745;">
                                        @Model.Items[i].Amount.ToString("C")
                                        <input type="hidden" name="Items[@i].Amount" value="@Model.Items[i].Amount" />
                                    </td>
                                    <td>
                                        @Model.Items[i].PRNo
                                        <input type="hidden" name="Items[@i].PRNo" value="@Model.Items[i].PRNo" />
                                    </td>
                                </tr>
                            }
                        </tbody>
                        <tfoot>
                        @{
                            var poSubtotal = Model.Items.Sum(i => {
                                var itemSubtotal = i.Quantity * i.UnitPrice;
                                var discount = i.DiscountPercent > 0 
                                    ? (itemSubtotal * i.DiscountPercent / 100) 
                                    : i.DiscountAmount;
                                return itemSubtotal - discount;
                            });
                            var firstGST = Model.Items.FirstOrDefault()?.GST ?? "7%";
                            var gstRate = decimal.Parse(firstGST.Replace("%", "").Trim());
                            var poGST = poSubtotal * (gstRate / 100);
                            var poGrandTotal = poSubtotal + poGST;
                        }
                        <tr>
                        <td colspan="6" style="text-align: right; padding-right: 20px;">SUBTOTAL:</td>
                        <td>@poSubtotal.ToString("C")</td>
                        <td></td>
                        </tr>
                        <tr>
                        <td colspan="6" style="text-align: right; padding-right: 20px;">GST (@gstRate%):</td>
                        <td>@poGST.ToString("C")</td>
                        <td></td>
                        </tr>
                        <tr style="background: #004499; color: white;">
                        <td colspan="6" style="text-align: right; padding-right: 20px;">GRAND TOTAL:</td>
                        <td>@poGrandTotal.ToString("C")</td>
                        <td></td>
                        </tr>
                        </tfoot>
                        </table>
                    </div>

                    <!-- Remarks Section -->
                    <div class="section-card">
                        <div class="section-header">
                            <i class="fas fa-comment-alt"></i> Additional Remarks
                        </div>
                        <div class="form-group">
                            <textarea asp-for="Remarks" class="form-control" rows="4" placeholder="Enter any additional remarks or special instructions..."></textarea>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="action-buttons">
                        <button type="submit" class="btn-submit">
                            <i class="fas fa-check-circle"></i> Create Purchase Order
                        </button>
                        <a href="@Url.Action("CompletedRequests", "PurchaseRequisition")" class="btn-cancel">
                            <i class="fas fa-times-circle"></i> Cancel
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}
