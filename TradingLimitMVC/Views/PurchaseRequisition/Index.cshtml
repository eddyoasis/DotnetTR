@model TradingLimitMVC.Models.ViewModels.PRIndexViewModel
@{
    ViewData["Title"] = "Purchase Requisitions";
}

<style>
    .backfont {
        color: black
    }

    .bluee {
        color: #004499;
    }

</style>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h2>
                <i class="fas fa-file-alt"></i> Purchase Requisitions
                <span class="badge bg-secondary">@Model.TotalCount</span>
            </h2>
        </div>
        <div class="col text-end">
            <a asp-action="Create" class="btn btn-primary">
                <i class="fas fa-plus"></i> Create New PR
            </a>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-filter"></i> Filters
                <button class="btn btn-sm btn-link float-end" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse">
                    <i class="fas fa-chevron-down"></i>
                </button>
            </h5>
        </div>
        <div class="collapse show" id="filterCollapse">
            <div class="card-body">
                <form asp-action="Index" method="get" id="filterForm">
                    <div class="row g-3">
                        <!-- PR Reference -->
                        <div class="col-md-3">
                            <label class="form-label">PR Reference</label>
                            <input type="text" class="form-control" name="PRReference" value="@Model.Filters.PRReference" placeholder="Search PR..." />
                        </div>

                        <!-- Company -->
                        <div class="col-md-3">
                            <label class="form-label">Company</label>
                            <select class="form-select" name="Company">
                                <option value="">All Companies</option>
                                @foreach (var company in Model.Companies)
                                {
                                    <option value="@company" selected="@(Model.Filters.Company == company)">@company</option>
                                }
                            </select>
                        </div>

                        @* <!-- Department -->
                        <div class="col-md-3">
                            <label class="form-label">Department</label>
                            <select class="form-select" name="Department">
                                <option value="">All Departments</option>
                                @foreach (var dept in Model.Departments)
                                {
                                    <option value="@dept" selected="@(Model.Filters.Department == dept)">@dept</option>
                                }
                            </select>
                        </div> *@

                        <!-- Status -->
                        <div class="col-md-3">
                            <label class="form-label">Status</label>
                            <select class="form-select" name="Status">
                                <option value="">All Statuses</option>
                                @foreach (WorkflowStatus status in Enum.GetValues(typeof(WorkflowStatus)))
                                {
                                    <option value="@status" selected="@(Model.Filters.Status == status)">@status</option>
                                }
                            </select>
                        </div>

                        <!-- Submitted By -->
                        <div class="col-md-3">
                            <label class="form-label">Submitted By</label>
                            <input type="text" class="form-control" name="SubmittedBy" value="@Model.Filters.SubmittedBy" placeholder="User name..." />
                        </div>

                        <!-- Date From -->
                        <div class="col-md-3">
                            <label class="form-label">Date From</label>
                            <input type="date" class="form-control" name="DateFrom" value="@Model.Filters.DateFrom?.ToString("yyyy-MM-dd")" />
                        </div>

                        <!-- Date To -->
                        <div class="col-md-3">
                            <label class="form-label">Date To</label>
                            <input type="date" class="form-control" name="DateTo" value="@Model.Filters.DateTo?.ToString("yyyy-MM-dd")" />
                        </div>

                        <!-- Amount Range -->
                        <div class="col-md-3">
                            <label class="form-label">Amount Range</label>
                            <div class="input-group">
                                <input type="number" class="form-control" name="AmountFrom" value="@Model.Filters.AmountFrom" placeholder="Min" step="0.01" />
                                <span class="input-group-text">-</span>
                                <input type="number" class="form-control" name="AmountTo" value="@Model.Filters.AmountTo" placeholder="Max" step="0.01" />
                            </div>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i> Apply Filters
                            </button>
                            <a asp-action="Index" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Clear Filters
                            </a>
                        </div>
                    </div>

                    <!-- Hidden fields for sorting and pagination -->
                    <input type="hidden" name="SortBy" value="@Model.Filters.SortBy" />
                    <input type="hidden" name="SortOrder" value="@Model.Filters.SortOrder" />
                    <input type="hidden" name="PageSize" value="@Model.Filters.PageSize" />
                </form>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>
                Showing @((Model.Filters.PageNumber - 1) * Model.Filters.PageSize + 1)
                to @(Math.Min(Model.Filters.PageNumber * Model.Filters.PageSize, Model.TotalCount))
                of @Model.TotalCount results
            </span>
            <div>
                <label>Show:</label>
                <select class="form-select form-select-sm d-inline-block w-auto" onchange="changePageSize(this.value)">
                    <option value="10" selected="@(Model.Filters.PageSize == 10)">10</option>
                    <option value="25" selected="@(Model.Filters.PageSize == 25)">25</option>
                    <option value="50" selected="@(Model.Filters.PageSize == 50)">50</option>
                    <option value="100" selected="@(Model.Filters.PageSize == 100)">100</option>
                </select>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-striped mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>
                                <a href="#" onclick="sortTable('PRReference')">
                                    PR Reference
                                    @if (Model.Filters.SortBy == "PRReference")
                                    {
                                        <i class="fas fa-sort-@(Model.Filters.SortOrder == "asc" ? "up" : "down")"></i>
                                    }
                                </a>
                            </th>
                            <th>
                                <a href="#" onclick="sortTable('Company')">
                                    Company
                                    @if (Model.Filters.SortBy == "Company")
                                    {
                                        <i class="fas fa-sort-@(Model.Filters.SortOrder == "asc" ? "up" : "down")"></i>
                                    }
                                </a>
                            </th>
                            @* <th>Department</th> *@
                            <th>
                                <a href="#" onclick="sortTable('SubmittedBy')">
                                    Submitted By
                                    @if (Model.Filters.SortBy == "SubmittedBy")
                                    {
                                        <i class="fas fa-sort-@(Model.Filters.SortOrder == "asc" ? "up" : "down")"></i>
                                    }
                                </a>
                            </th>
                            <th>
                                <a href="#" onclick="sortTable('CreatedDate')">
                                    Date
                                    @if (Model.Filters.SortBy == "CreatedDate" || string.IsNullOrEmpty(Model.Filters.SortBy))
                                    {
                                        <i class="fas fa-sort-@(Model.Filters.SortOrder == "asc" ? "up" : "down")"></i>
                                    }
                                </a>
                            </th>
                            <th>
                                <a href="#" onclick="sortTable('TotalAmount')">
                                    Amount
                                    @if (Model.Filters.SortBy == "TotalAmount")
                                    {
                                        <i class="fas fa-sort-@(Model.Filters.SortOrder == "asc" ? "up" : "down")"></i>
                                    }
                                </a>
                            </th>
                            <th>
                                <a href="#" onclick="sortTable('Status')">
                                    Status
                                    @if (Model.Filters.SortBy == "Status")
                                    {
                                        <i class="fas fa-sort-@(Model.Filters.SortOrder == "asc" ? "up" : "down")"></i>
                                    }
                                </a>
                            </th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.PurchaseRequisitions.Any())
                        {
                            @foreach (var pr in Model.PurchaseRequisitions)
                            {
                                <tr>
                                    <td><strong>@(pr.PRReference ?? "N/A")</strong></td>
                                    <td>@(pr.Company ?? "N/A")</td>
                                    <td>@(pr.SubmittedBy ?? "N/A")</td>
                                    <td>@pr.CreatedDate.ToString("dd MMM yyyy")</td>
                                    <td>@(pr.QuotationCurrency ?? "USD") @pr.TotalAmount.ToString("N2")</td>
                                    <td>
                                        @{
                                            var statusClass = pr.CurrentStatus switch
                                            {
                                                WorkflowStatus.Approved => "success",
                                                WorkflowStatus.Rejected => "danger",
                                                WorkflowStatus.Pending => "warning",
                                                WorkflowStatus.Draft => "secondary",
                                                _ => "info"
                                            };
                                        }
                                        <span class="badge bg-@statusClass">@pr.CurrentStatus</span>
                                    </td>
                                    <td>
                                        <a asp-action="Details" asp-route-id="@pr.Id" class="btn btn-sm btn-info" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        @* @if (pr.CurrentStatus == WorkflowStatus.Draft)
                                        {
                                            <a asp-action="Edit" asp-route-id="@pr.Id" class="btn btn-sm btn-warning" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                        } *@
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="7" class="text-center py-4">
                                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">No purchase requisitions found matching your filters.</p>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pagination -->
        @if (Model.TotalPages > 1)
        {
            <div class="card-footer">
                <nav>
                    <ul class="pagination justify-content-center mb-0">
                        <li class="page-item @(Model.Filters.PageNumber == 1 ? "disabled" : "")">
                            <a class="page-link" href="#" onclick="changePage(1)">First</a>
                        </li>
                        <li class="page-item @(Model.Filters.PageNumber == 1 ? "disabled" : "")">
                            <a class="page-link" href="#" onclick="changePage(@(Model.Filters.PageNumber - 1))">Previous</a>
                        </li>

                        @for (int i = Math.Max(1, Model.Filters.PageNumber - 2); i <= Math.Min(Model.TotalPages, Model.Filters.PageNumber + 2); i++)
                        {
                            <li class="page-item @(i == Model.Filters.PageNumber ? "active" : "")">
                                <a class="page-link" href="#" onclick="changePage(@i)">@i</a>
                            </li>
                        }

                        <li class="page-item @(Model.Filters.PageNumber == Model.TotalPages ? "disabled" : "")">
                            <a class="page-link" href="#" onclick="changePage(@(Model.Filters.PageNumber + 1))">Next</a>
                        </li>
                        <li class="page-item @(Model.Filters.PageNumber == Model.TotalPages ? "disabled" : "")">
                            <a class="page-link" href="#" onclick="changePage(@Model.TotalPages)">Last</a>
                        </li>
                    </ul>
                </nav>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        function sortTable(column) {
            const form = document.getElementById('filterForm');
            const sortByInput = form.querySelector('input[name="SortBy"]');
            const sortOrderInput = form.querySelector('input[name="SortOrder"]');

            if (sortByInput.value === column) {
                sortOrderInput.value = sortOrderInput.value === 'asc' ? 'desc' : 'asc';
            } else {
                sortByInput.value = column;
                sortOrderInput.value = 'asc';
            }

            form.submit();
        }

        function changePage(pageNumber) {
            const form = document.getElementById('filterForm');
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'PageNumber';
            input.value = pageNumber;
            form.appendChild(input);
            form.submit();
        }

        function changePageSize(pageSize) {
            const form = document.getElementById('filterForm');
            const input = form.querySelector('input[name="PageSize"]') || document.createElement('input');
            input.type = 'hidden';
            input.name = 'PageSize';
            input.value = pageSize;
            if (!form.contains(input)) {
                form.appendChild(input);
            }
            form.submit();
        }
    </script>
}